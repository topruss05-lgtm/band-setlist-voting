---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    return Astro.redirect("/signin");
  }
} catch (error) {
  return Astro.redirect("/signin");
}
---

<Layout title="Song vorschlagen - Band Setlist">
  <nav>
    <div class="nav-content">
      <h1>Band Setlist Voting</h1>
      <div>
        <a href="/dashboard">Dashboard</a>
        <a href="/vote">Abstimmen</a>
        <a href="/setlist">Setliste</a>
        <a href="/api/auth/signout">Abmelden</a>
      </div>
    </div>
  </nav>
  <div class="container">
    <h2>Song vorschlagen</h2>
    <form action="/api/songs/suggest" method="post">
      <label for="title">Song-Titel</label>
      <input type="text" name="title" id="title" required placeholder="z.B. Bohemian Rhapsody - Queen" />

      <label for="youtube_url">YouTube-URL</label>
      <input
        type="url"
        name="youtube_url"
        id="youtube_url"
        required
        placeholder="https://www.youtube.com/watch?v=..."
        pattern="https://.*youtube\.com/.*|https://.*youtu\.be/.*"
        title="Bitte eine gültige YouTube-URL eingeben"
      />

      <button type="submit">Song vorschlagen</button>
    </form>

    <p style="margin-top: 1rem;">
      <a href="/vote" class="link">Zurück zur Abstimmung</a>
    </p>
  </div>
</Layout>
